<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLoad 固件管理器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="styles/style.css" rel="stylesheet">
    <link href="styles/firmware-style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-chip"></i> OpenLoad 固件管理器
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item">
                    <span class="navbar-text">
                        <i class="bi bi-cloud-check text-success"></i> Web端已连接
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- 页面标题和说明 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info border-0 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-info-circle-fill" style="font-size: 2rem;"></i>
                        </div>
                        <div>
                            <h5 class="alert-heading mb-1">OpenLoad 固件管理平台</h5>
                            <p class="mb-0">专业的STM32固件管理解决方案 - 安全加密传输，智能版本控制，让嵌入式开发更高效。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- 左侧面板 - 固件上传 -->
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-cloud-upload"></i> 固件上传
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="upload-form">
                            <div class="mb-3">
                                <label for="firmware-file" class="form-label">选择固件文件 (.bin)</label>
                                <input class="form-control" type="file" id="firmware-file" accept=".bin" required>
                                <div class="form-text">支持最大16MB的.bin格式固件文件</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">固件版本 <small class="text-muted">(必填)</small></label>
                                <div class="row g-2">
                                    <div class="col">
                                        <label for="version-major" class="form-label small text-muted">主版本</label>
                                        <input type="number" 
                                               class="form-control text-center" 
                                               id="version-major" 
                                               min="0" 
                                               max="999" 
                                               placeholder="2"
                                               required>
                                    </div>
                                    <div class="col-1 d-flex align-items-end justify-content-center">
                                        <span class="mb-2 h5 text-muted">.</span>
                                    </div>
                                    <div class="col">
                                        <label for="version-minor" class="form-label small text-muted">次版本</label>
                                        <input type="number" 
                                               class="form-control text-center" 
                                               id="version-minor" 
                                               min="0" 
                                               max="999" 
                                               placeholder="1"
                                               required>
                                    </div>
                                    <div class="col-1 d-flex align-items-end justify-content-center">
                                        <span class="mb-2 h5 text-muted">.</span>
                                    </div>
                                    <div class="col">
                                        <label for="version-patch" class="form-label small text-muted">修订版</label>
                                        <input type="number" 
                                               class="form-control text-center" 
                                               id="version-patch" 
                                               min="0" 
                                               max="999" 
                                               placeholder="5"
                                               required>
                                    </div>
                                    <div class="col-1 d-flex align-items-end justify-content-center">
                                        <span class="mb-2 h5 text-muted">.</span>
                                    </div>
                                    <div class="col">
                                        <label for="version-build" class="form-label small text-muted">构建版(年份)</label>
                                        <select class="form-select text-center" id="version-build" required>
                                            <!-- 年份选项将通过JavaScript动态生成 -->
                                        </select>
                                    </div>
                                </div>
                                <div class="form-text mt-2">
                                    <strong>版本格式预览：</strong> 
                                    <code id="version-preview">v<span id="preview-major">2</span>.<span id="preview-minor">1</span>.<span id="preview-patch">5</span>.<span id="preview-build">2024</span></code>
                                </div>
                                <div class="invalid-feedback" id="version-error">
                                    请填写完整的版本号
                                </div>
                                <!-- 隐藏的输入框用于表单提交 -->
                                <input type="hidden" id="firmware-version" name="firmware-version">
                            </div>

                            <div class="mb-3">
                                <label for="target-device" class="form-label">目标设备</label>
                                <select class="form-select" id="target-device">
                                    <option value="STM32F103ZET6" selected>STM32F103ZET6</option>
                                    <option value="STM32F103VET6">STM32F103VET6</option>
                                    <option value="STM32F407ZET6">STM32F407ZET6</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>

                            <!-- 加密选项 -->
                            <div class="mb-3">
                                <label class="form-label">加密算法</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="upload-encryption-type" 
                                           id="upload-no-encryption" value="none" checked>
                                    <label class="form-check-label" for="upload-no-encryption">
                                        <strong>无加密</strong> - 固件不加密，直接使用
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="upload-encryption-type" 
                                           id="upload-xor-encryption" value="xor">
                                    <label class="form-check-label" for="upload-xor-encryption">
                                        <strong>XOR加密</strong> - 简单快速的异或加密
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="upload-encryption-type" 
                                           id="upload-aes128-encryption" value="aes-128-cbc">
                                    <label class="form-check-label" for="upload-aes128-encryption">
                                        <strong>AES-128-CBC</strong> - 高安全性加密(推荐)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="upload-encryption-type" 
                                           id="upload-aes256-encryption" value="aes-256-cbc">
                                    <label class="form-check-label" for="upload-aes256-encryption">
                                        <strong>AES-256-CBC</strong> - 最高安全性加密
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3" id="upload-encryption-key-section" style="display: none;">
                                <label class="form-label">加密方式</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="upload-key-method" 
                                           id="upload-key-password" value="password" checked>
                                    <label class="form-check-label" for="upload-key-password">使用密码生成密钥</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="upload-key-method" 
                                           id="upload-key-manual" value="manual">
                                    <label class="form-check-label" for="upload-key-manual">手动输入密钥</label>
                                </div>
                            </div>

                            <div class="mb-3" id="upload-password-section" style="display: none;">
                                <label for="upload-encryption-password" class="form-label">加密密码</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="upload-encryption-password" 
                                           placeholder="输入用于生成密钥的密码">
                                    <button type="button" class="btn btn-outline-info" onclick="generateUploadRandomPassword()">
                                        <i class="bi bi-key"></i> 随机生成
                                    </button>
                                </div>
                                <div class="form-text">系统将使用PBKDF2从密码生成安全密钥，或点击按钮随机生成强密码</div>
                            </div>

                            <div class="mb-3" id="upload-manual-key-section" style="display: none;">
                                <label for="upload-encryption-key" class="form-label">加密密钥 (十六进制)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="upload-encryption-key" 
                                           placeholder="例如：0123456789ABCDEF...">
                                    <button type="button" class="btn btn-outline-info" onclick="generateUploadRandomKey()">
                                        <i class="bi bi-dice-3"></i> 生成
                                    </button>
                                </div>
                                <div class="form-text">
                                    <span id="upload-key-length-hint">XOR: 1-32字节, AES-128: 16字节, AES-256: 32字节</span>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="bi bi-upload"></i> 上传并处理固件
                            </button>
                        </form>

                        <!-- 上传进度 -->
                        <div class="mt-3" id="upload-progress" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="upload-progress-bar" role="progressbar" style="width: 0%">
                                </div>
                            </div>
                            <small class="text-muted" id="upload-message">准备上传...</small>
                        </div>
                    </div>
                </div>

            </div>

            <!-- 右侧面板 - 固件列表 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-files"></i> 固件列表
                        </h5>
                        <div>
                            <button class="btn btn-light btn-sm" onclick="refreshFirmwareList()">
                                <i class="bi bi-arrow-clockwise"></i> 刷新
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="showStorageInfo()">
                                <i class="bi bi-hdd"></i> 存储信息
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th width="40%">固件名称</th>
                                        <th width="15%">版本</th>
                                        <th width="15%">大小</th>
                                        <th width="15%">加密</th>
                                        <th width="15%">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="firmware-list">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="bi bi-inbox"></i><br>
                                            暂无固件文件<br>
                                            <small>请上传.bin格式的固件文件</small>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 固件详情 -->
                <div class="card mt-4" id="firmware-details" style="display: none;">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-info-circle"></i> 固件详情
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="firmware-details-content">
                            <!-- 固件详情内容 -->
                        </div>
                    </div>
                </div>

                <!-- 系统信息 -->
                <div class="card mt-4">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-gear"></i> 系统状态
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-primary">
                                    <i class="bi bi-files" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="fw-bold" id="firmware-count">0</div>
                                <div class="small text-muted">固件数量</div>
                            </div>
                            <div class="col-4">
                                <div class="text-warning">
                                    <i class="bi bi-shield-lock" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="fw-bold" id="encrypted-count">0</div>
                                <div class="small text-muted">已加密</div>
                            </div>
                            <div class="col-4">
                                <div class="text-info">
                                    <i class="bi bi-hdd" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="fw-bold" id="storage-used">0MB</div>
                                <div class="small text-muted">已使用</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between small">
                                <span>API状态</span>
                                <span class="text-success">正常</span>
                            </div>
                            <div class="d-flex justify-content-between small">
                                <span>服务器版本</span>
                                <span>WebLoad v2.0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 消息通知 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-info-circle text-primary me-2"></i>
                <strong class="me-auto">OpenLoad</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-body">
                消息内容
            </div>
        </div>
    </div>

    <!-- 确认删除对话框 -->
    <div class="position-fixed top-50 start-50 translate-middle" id="deleteConfirmDialog" style="display: none; z-index: 9999;">
        <div class="card border-0 shadow-lg" style="min-width: 400px;">
            <div class="card-body text-center p-4">
                <div class="mb-3">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                </div>
                <h5 class="card-title text-dark mb-3" id="deleteTitle">删除固件</h5>
                <p class="card-text text-muted mb-4" id="deleteMessage">
                    确定要删除此固件吗？此操作无法撤销。
                </p>
                <div class="d-flex gap-3 justify-content-center">
                    <button type="button" class="btn btn-outline-secondary px-4" id="deleteCancelBtn">
                        <i class="bi bi-x-lg me-2"></i>取消
                    </button>
                    <button type="button" class="btn btn-danger px-4" id="deleteConfirmBtn">
                        <i class="bi bi-trash me-2"></i>删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 背景遮罩 -->
    <div class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50" id="deleteBackdrop" style="display: none; z-index: 9998;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="firmware-manager.js"></script>
</body>
</html>