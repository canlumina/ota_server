<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLoad 后台管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .api-endpoint {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        .method-badge {
            font-size: 0.75rem;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 0.875rem;
        }
        .test-result {
            max-height: 400px;
            overflow-y: auto;
        }
        .firmware-table th {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        .sidebar {
            background: linear-gradient(180deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            min-height: 100vh;
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            border-radius: 0.5rem;
            margin: 0.25rem 0;
        }
        .sidebar .nav-link:hover, 
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .content-area {
            background: #f8fafc;
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div class="row g-0">
        <!-- 侧边栏 -->
        <div class="col-md-3 col-lg-2 sidebar">
            <div class="p-3">
                <h4 class="mb-4">
                    <i class="bi bi-gear-fill me-2"></i>OpenLoad 后台
                </h4>
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#dashboard" onclick="showSection('dashboard')">
                        <i class="bi bi-speedometer2 me-2"></i>仪表板
                    </a>
                    <a class="nav-link" href="#firmware-list" onclick="showSection('firmware-list')">
                        <i class="bi bi-files me-2"></i>固件列表
                    </a>
                    <a class="nav-link" href="#api-docs" onclick="showSection('api-docs')">
                        <i class="bi bi-book me-2"></i>API文档
                    </a>
                    <a class="nav-link" href="#api-test" onclick="showSection('api-test')">
                        <i class="bi bi-terminal me-2"></i>API测试
                    </a>
                    <hr class="my-3" style="border-color: rgba(255,255,255,0.2);">
                    <a class="nav-link" href="#" id="frontend-link" target="_blank">
                        <i class="bi bi-arrow-up-right-square me-2"></i>前端页面
                    </a>
                </nav>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="col-md-9 col-lg-10 content-area">
            <div class="p-4">
                
                <!-- 仪表板 -->
                <div id="dashboard" class="section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-speedometer2 me-2"></i>系统仪表板</h2>
                        <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                            <i class="bi bi-arrow-clockwise me-2"></i>刷新数据
                        </button>
                    </div>

                    <!-- 统计卡片 -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <div class="text-primary mb-2">
                                        <i class="bi bi-files" style="font-size: 2rem;"></i>
                                    </div>
                                    <h3 class="mb-1" id="total-firmwares">0</h3>
                                    <p class="text-muted mb-0">固件总数</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <div class="text-success mb-2">
                                        <i class="bi bi-shield-check" style="font-size: 2rem;"></i>
                                    </div>
                                    <h3 class="mb-1" id="encrypted-firmwares">0</h3>
                                    <p class="text-muted mb-0">已加密</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <div class="text-info mb-2">
                                        <i class="bi bi-hdd" style="font-size: 2rem;"></i>
                                    </div>
                                    <h3 class="mb-1" id="total-size">0MB</h3>
                                    <p class="text-muted mb-0">占用空间</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <div class="text-warning mb-2">
                                        <i class="bi bi-star" style="font-size: 2rem;"></i>
                                    </div>
                                    <h3 class="mb-1" id="latest-version">-</h3>
                                    <p class="text-muted mb-0">最新版本</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 最新固件 -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>最近上传的固件</h5>
                        </div>
                        <div class="card-body">
                            <div id="recent-firmwares">正在加载...</div>
                        </div>
                    </div>
                </div>

                <!-- 固件列表 -->
                <div id="firmware-list" class="section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-files me-2"></i>固件列表管理</h2>
                        <div class="btn-group">
                            <button class="btn btn-outline-success" onclick="exportFirmwareList()">
                                <i class="bi bi-download me-2"></i>导出列表
                            </button>
                            <button class="btn btn-outline-primary" onclick="refreshFirmwareList()">
                                <i class="bi bi-arrow-clockwise me-2"></i>刷新
                            </button>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 firmware-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="30%">固件名称</th>
                                            <th width="15%">版本号</th>
                                            <th width="12%">文件大小</th>
                                            <th width="12%">加密状态</th>
                                            <th width="18%">上传时间</th>
                                            <th width="13%">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="firmware-table-body">
                                        <tr>
                                            <td colspan="6" class="text-center py-4">
                                                <div class="spinner-border spinner-border-sm me-2"></div>
                                                正在加载固件列表...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API文档 -->
                <div id="api-docs" class="section" style="display: none;">
                    <h2 class="mb-4"><i class="bi bi-book me-2"></i>API接口文档</h2>
                    
                    <div class="row">
                        <!-- 基础API -->
                        <div class="col-12 mb-4">
                            <h4>基础固件API</h4>
                            
                            <div class="api-endpoint">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-primary method-badge me-2">GET</span>
                                    <code>/api/v1/firmwares</code>
                                </div>
                                <p class="mb-2"><strong>获取所有固件列表</strong></p>
                                <p class="text-muted mb-2">参数: target_device (可选), encrypted_only (可选)</p>
                                <p class="mb-0">返回固件列表，按版本号排序，自动标记最新版本</p>
                            </div>

                            <div class="api-endpoint">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-success method-badge me-2">GET</span>
                                    <code>/api/v1/firmwares/latest</code>
                                </div>
                                <p class="mb-2"><strong>获取最新版本固件</strong></p>
                                <p class="text-muted mb-2">参数: target_device (可选), download=true (下载固件二进制文件)</p>
                                <p class="mb-2">返回版本号最高的固件信息，包含download_url字段</p>
                                <p class="mb-0 text-info"><strong>OTA升级:</strong> 单片机可使用 <code>?download=true</code> 参数直接下载固件文件</p>
                            </div>

                            <div class="api-endpoint">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-info method-badge me-2">GET</span>
                                    <code>/api/v1/firmwares/version/&lt;version&gt;</code>
                                </div>
                                <p class="mb-2"><strong>根据版本号获取固件</strong></p>
                                <p class="text-muted mb-2">参数: version (必需), target_device (可选), download=true (下载固件二进制文件)</p>
                                <p class="mb-2">获取指定版本的固件，支持 v1.0.0.2025 或 1.0.0.2025 格式</p>
                                <p class="mb-0 text-info"><strong>回滚/升级:</strong> 单片机可下载特定版本固件进行回滚或指定版本升级</p>
                            </div>

                            <div class="api-endpoint">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-warning method-badge me-2">GET</span>
                                    <code>/api/v1/firmwares/versions</code>
                                </div>
                                <p class="mb-2"><strong>获取所有版本号列表</strong></p>
                                <p class="text-muted mb-2">参数: target_device (可选)</p>
                                <p class="mb-0">返回精简的版本信息列表，适合版本选择器</p>
                            </div>
                        </div>

                        <!-- OTA升级API -->
                        <div class="col-12 mb-4">
                            <h4>OTA升级专用API</h4>
                            <p class="text-muted">单片机可以直接通过以下API进行无线固件更新</p>
                            
                            <div class="api-endpoint">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-danger method-badge me-2">OTA</span>
                                    <code>/api/v1/firmwares/latest?download=true</code>
                                </div>
                                <p class="mb-2"><strong>下载最新固件用于OTA升级</strong></p>
                                <p class="text-muted mb-2">响应: 固件二进制文件流 (application/octet-stream)</p>
                                <p class="mb-2">HTTP头: Content-Length (文件大小), Content-Disposition (文件名)</p>
                                <div class="code-block mt-2">// 单片机HTTP请求示例
GET /api/v1/firmwares/latest?download=true&target_device=STM32F103ZET6 HTTP/1.1
Host: 192.168.1.100:8080
User-Agent: STM32-OTA/1.0
Accept: application/octet-stream</div>
                            </div>

                            <div class="api-endpoint">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-danger method-badge me-2">OTA</span>
                                    <code>/api/v1/firmwares/version/&lt;version&gt;?download=true</code>
                                </div>
                                <p class="mb-2"><strong>下载指定版本固件</strong></p>
                                <p class="text-muted mb-2">适用于固件回滚或指定版本升级</p>
                                <div class="code-block mt-2">// 下载指定版本示例
curl -O "http://127.0.0.1:8080/api/v1/firmwares/version/v1.0.0.2025?download=true"</div>
                            </div>
                        </div>

                        <!-- 示例响应 -->
                        <div class="col-12">
                            <h4>API响应示例</h4>
                            <h6>获取最新固件信息响应:</h6>
                            <div class="code-block">{
  "success": true,
  "data": {
    "id": "fw_1756823751_20250902_223551_RTC2",
    "filename": "20250902_223551_RTC2.bin",
    "original_filename": "RTC2.bin",
    "version": "v1.0.0.2025",
    "size": 16224,
    "checksum": "0fd3133385b63af8a9027704a1dd3fba",
    "upload_time": "2025-09-02T22:35:51.277366",
    "target_device": "STM32F103ZET6",
    "is_encrypted": true,
    "is_latest": true,
    "download_url": "/api/v1/firmwares/latest?download=true"
  },
  "message": "获取最新固件成功: v1.0.0.2025"
}
</div>
                            <h6>OTA固件下载响应 (HTTP 200):</h6>
                            <div class="code-block">Content-Type: application/octet-stream
Content-Length: 16224
Content-Disposition: attachment; filename=RTC2.bin

[二进制固件数据流...]</div>
                        </div>
                    </div>
                </div>

                <!-- API测试 -->
                <div id="api-test" class="section" style="display: none;">
                    <h2 class="mb-4"><i class="bi bi-terminal me-2"></i>API接口测试</h2>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header">
                                    <h5 class="mb-0">API测试工具</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">API端点</label>
                                        <select class="form-select" id="api-endpoint">
                                            <option value="/api/v1/firmwares">获取所有固件</option>
                                            <option value="/api/v1/firmwares/latest">获取最新固件</option>
                                            <option value="/api/v1/firmwares/versions">获取版本列表</option>
                                            <option value="custom">自定义...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3" id="custom-endpoint-group" style="display: none;">
                                        <label class="form-label">自定义端点</label>
                                        <input type="text" class="form-control" id="custom-endpoint" placeholder="/api/v1/firmwares/version/v1.0.0.2025">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">目标设备 (可选)</label>
                                        <input type="text" class="form-control" id="target-device" placeholder="STM32F103ZET6">
                                    </div>
                                    <button class="btn btn-primary w-100" onclick="testAPI()">
                                        <i class="bi bi-play-circle me-2"></i>测试API
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">测试结果</h5>
                                    <small class="text-muted" id="test-status">等待测试...</small>
                                </div>
                                <div class="card-body">
                                    <div class="test-result">
                                        <div class="code-block" id="test-response">点击"测试API"按钮开始测试</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
</body>
</html>